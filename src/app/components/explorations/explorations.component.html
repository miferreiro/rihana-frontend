<!--
  ~ RIHANA Frontend
  ~
  ~ Copyright (C) 2021 David A. Ruano Ordás, José Ramón Méndez Reboredo,
  ~ Miguel Ferreiro Díaz
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public
  ~ License along with this program.  If not, see
  ~ <http://www.gnu.org/licenses/gpl-3.0.html>.
-->

<div class="container pb-2">
	<div class="row summary mt-2 mb-3 text-center">
		<h2>{{'Signs detected' | translate}}</h2>
		<div class="col-md-6 col-sm-12">
			<app-pie-chart
				[updateChart]="updateChart.asObservable()">
			</app-pie-chart>
		</div>
		<div class="col-md-6 col-sm-12">
			<app-bar-chart
				[updateChart]="updateChart.asObservable()">
			</app-bar-chart>
		</div>
	</div>

	<h2 class="text-center m-4">{{'Latest explorations' | translate}}</h2>

	<div class="row">
		<div class="col-xl-5 col-12 my-2 px-1 d-flex align-items-center">
			<button type="button" class="input-group-text btn btn-success" (click)="addExploration()">
				<i class="las la-plus la-lg me-2"></i> {{'Add exploration' | translate}}
			</button>
		</div>
		<form class="col-xl-4 col-12 my-2 px-1 align-self-center text-center">
			<div class="gx-0">
				<ng-select  name="signTypesSelect"
							notFoundText="{{'No sign types found' | translate}}"
							placeholder="{{'Search by sign types' | translate}}"
							[clearable]="true"
							[closeOnSelect]="false"
							[dropdownPosition]="'top'"
							[hideSelected]="true"
							[multiple]="true"
							[searchable]="false"
							[(ngModel)]="signTypesFilter"
							(change)="searchBySignTypes()">
					<ng-option *ngFor="let signType of signTypes" [value]="signType">
						{{signType.code}}
					</ng-option>

					<ng-template ng-label-tmp let-item="item" let-clear="clear">
						<span class="ng-value-label"
								[ngStyle]="{'background-color': item.primaryColor + 'CC', 'color': item.secondaryColor}">
							{{item.code}}
						</span>
						<span class="ng-value-icon right"
								[ngStyle]="{'background-color': item.primaryColor + 'CC', 'color': item.secondaryColor, 'border-left': 'none'}"
								aria-hidden="true"
								(click)="clear(item)">
								×
						</span>
					</ng-template>

					<ng-template ng-option-tmp let-item="item">
						<div class="ng-option" [ngStyle]="{'border-color': item.primaryColor}">
							{{item.name | translate}} ({{item.code}})
						</div>
					</ng-template>
				</ng-select>
			</div>
		</form>
		<div class="col-xl-3 col-12 my-2 px-1 d-flex align-items-center">
			<div class="daterangerpicker"
				 daterangepicker
				 [options]="options"
				 (selected)="selectedDate($event)"
				 (applyDaterangepicker)="applyDate()"
				 (cancelDaterangepicker)="cancelDate()">
				<div class="d-flex justify-content-between h-100">
					<span *ngIf="initialDate != undefined" class="ps-2 align-self-center">
						{{initialDate | date: currentFormatDate}} - {{finalDate | date: currentFormatDate}}
					</span>
					<span *ngIf="initialDate == undefined" class="placeholder align-self-center">
						{{'Select a range' | translate}}
					</span>
					<div class="align-self-center">
						<span *ngIf="initialDate != undefined" class="cancel"
							(click)="cancelDate()">×</span>
						<span>
							<button class="btn"><i class="bi bi-calendar"></i></button>
						</span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row d-flex justify-content-center" [ngClass]="{'mb-4': !(pageSize < paginationTotalItems && explorations.length != 0)}">
		<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-0 px-1">
			<div *ngFor="let exploration of explorations; let i=index" class="col px-1">
				<div class="card h-100">
					<div class="d-flex flex-column card-header">
						<small class="text-capitalize card-category">{{getRadiographType(exploration)}}</small>
						<h5 class="card-title">{{exploration.title}}</h5>
						<h6 *ngIf="!isAdmin() && !isSupervisor()"class="card-subtitle text-muted">{{exploration.explorationDate | date: currentFormatDate}}</h6>
						<h6 *ngIf="isAdmin() || isSupervisor()" class="card-subtitle text-muted"> <span class="text-capitalize">{{'by' | translate}} </span> <span class="text-capitalize">{{exploration.user}}</span>, {{'at' | translate}} {{exploration.explorationDate | date: currentFormatDate}}</h6>
					</div>
					<div class="row card-body mr-0 ml-0">
						<div *ngIf="getExplorationSigns(exploration).length != 0" class="row d-flex">
							<div *ngFor="let sign of getExplorationSigns(exploration); let i=index"
								 class="col-auto align-self-center">
								<div class="signType my-1" [ngStyle]="{'border-color': sign.type.primaryColor}">
									<span>{{sign.type.code}}</span>
									<span class="numSignType badge rounded-pill"
										  [ngStyle]="{'background-color': sign.type.primaryColor, 'color': sign.type.secondaryColor}">
											{{getNumExplorationSignType(exploration, sign.type.code)}}
									</span>
								</div>
							</div>
						</div>
					</div>
					<div class="card-footer">
						<div class="btn-group" role="group">
							<button class="btn" (click)="editExploration(exploration)"><i class="las la-edit la-lg"></i></button>
							<button class="btn border-start border-end" (click)="infoExploration(exploration)"><i class="bi bi-info-lg"></i></button>
							<button *ngIf="!exploration.deleted" class="btn" (click)="remove(exploration.id)"><i class="las la-trash-alt la-lg"></i></button>
							<button *ngIf="exploration.deleted" class="btn" (click)="recover(exploration.id)"><i class="las la-trash-restore-alt la-lg"></i></button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div *ngIf="pageSize < paginationTotalItems && explorations.length != 0" class ="row text-center mt-4">
			<ul class="pagination justify-content-center">
				<li class="page-item" [ngClass]="{'disabled': 1 > (currentPage - 1)}">
					<a class="page-link" aria-label="Previous" (click)="handlePageChange(currentPage - 1)">
						<span aria-hidden="true">&lt;</span>
					</a>
				</li>
				<li *ngIf="2 < currentPage" class="page-item" >
					<a class="page-link" (click)="handlePageChange(1)">
						1
					</a>
				</li>
				<li *ngIf="2 < currentPage" class="page-item align-self-center">
					...
				</li>
				<li *ngIf="currentPage != 1" class="page-item">
					<a class="page-link" (click)="handlePageChange(currentPage - 1)">
						{{currentPage - 1}}
					</a>
				</li>
				<li class="page-item">
					<a class="page-link currentPage" (click)="handlePageChange(currentPage)">
						{{currentPage}}
					</a>
				</li>
				<li *ngIf="lastPage > currentPage" class="page-item">
					<a class="page-link" (click)="handlePageChange(currentPage + 1)">
						{{currentPage + 1}}
					</a>
				</li>
				<li *ngIf="lastPage - 2> currentPage" class="page-item align-self-center">
					...
				</li>
				<li *ngIf="lastPage - 2 >= currentPage" class="page-item">
					<a class="page-link" (click)="handlePageChange(lastPage)">
						{{lastPage}}
					</a>
				</li>
				<li class="page-item" [ngClass]="{'disabled': (currentPage + 1) > lastPage}">
					<a class="page-link" aria-label="Next" (click)="handlePageChange(currentPage + 1)">
						<span aria-hidden="true">&gt;</span>
					</a>
				</li>
			</ul>
			<div *ngIf="pageSize < paginationTotalItems && explorations.length != 0" class ="row text-end mb-4">
				<span class="pagination-footer text-muted">
					{{'ExplorationPaginationFooter' |
						translate:"{currentPage:" + currentPage +
									", lastPage:" + lastPage +
									", paginationTotalItems:" + paginationTotalItems +"}"}}
				</span>
			</div>
		</div>
		<div id="no-data-explorations" [ngStyle]="{'display':explorations.length == 0 ? 'block' : 'none', 'opacity': explorations.length == 0 ? '1' : '0', 'visibility': explorations.length == 0 ? 'visible' : 'hidden'}"
			class="bg-light justify-content-center align-items-center ">
			<span class="alert align-middle" role="alert">
				{{'No data to display' | translate}}
			</span>
		</div>
	</div>
</div>

<app-delete-confirmation [(open)]="deletingExploration" [modelName]="'exploration'"
						 [id]="exploration.id" [name]="exploration.title"
						 (cancel)="cancel()" (confirm)="delete($event)">
</app-delete-confirmation>

<simple-notifications></simple-notifications>